<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CardÃ¡pio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4b7bec" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #f5f5fa;
      --card: #ffffff;
      --card-bg: #ffffff;
      --primary: #4b7bec;
      --primary-soft: #eef2ff;
      --secondary: #20bf6b;
      --accent: #f7b731;
      --border: #ddd;
      --text-main: #222;
      --text-muted: #666;
      --danger: #eb3b5a;
      --pill-bg: #eef2ff;
      --radius: 14px;
      --base-font-size: 17px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0;}

    html { font-size: var(--base-font-size); }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem 0.75rem 3rem;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    header h1 {
      font-size: 1.4rem; margin-bottom: 0.1rem;
    }
    .subtitle { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.4rem;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 1rem;
    }

    .font-controls {
      margin-top: 0.5rem;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.4rem;
    }

    .font-controls span {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .font-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 0.1rem 0.6rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 0 0 auto;
      min-width: auto;
      padding: 0.6rem 0.4rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .card-header h2 {
      font-size: 1.3rem;
      margin: 0;
    }

    .badge {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.85rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
      white-space: nowrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--primary);
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 500;
      background: #fff;
      color: var(--primary);
      cursor: pointer;
    }

    .btn.primary {
      background: var(--primary);
      color: #fff;
    }

    .btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn.sm {
      padding: 0.25rem 0.6rem;
      font-size: 0.85rem;
    }

    .btn + .btn { margin-left: 0.5rem; }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    select, input[type="text"], textarea, input[type="number"], input[type="url"] {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      font-family: inherit;
    }

    label {
      display: block;
      font-size: 0.95rem;
      margin: 0.35rem 0 0.15rem;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .field-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .field-row > div {
      flex: 1 1 140px;
    }

    .recipes-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .recipe-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 0.6rem 0.7rem;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .recipe-top {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
    }

    .recipe-photo {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .recipe-main {
      min-width: 0;
      flex: 1;
    }

    .recipe-name {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
      word-wrap: break-word;
    }

    .recipe-meta {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .recipe-link-inline {
      margin-top: 0.2rem;
      font-size: 0.9rem;
    }

    .recipe-link-inline a {
      text-decoration: underline;
    }

    .recipe-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      justify-content: flex-end;
    }

    .recipe-actions .btn.sm {
      min-width: 2rem;
      text-align: center;
      padding-inline: 0.5rem;
    }

    .recipe-details {
      margin-top: 0.4rem;
      border-top: 1px dashed var(--border);
      padding-top: 0.4rem;
    }

    .recipe-details ul {
      margin: 0.25rem 0 0.4rem;
      padding-left: 1.1rem;
      font-size: 0.95rem;
    }

    .section-title {
      font-weight: 600;
      margin: 0.6rem 0 0.25rem;
      font-size: 1rem;
    }

    .small {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .week-block { margin-top: 0.6rem; }

    .week-list {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
    }

    .week-list ul {
      margin: 0.2rem 0 0.4rem;
      padding-left: 1.1rem;
    }

    .week-list li {
      margin-bottom: 0.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .search-input { margin-bottom: 0.4rem; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 500px;
      width: calc(100% - 2rem);
      padding: 1rem;
      max-height: 80vh;
      overflow: auto;
    }

    .modal h2 {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }

    .modal-content { margin-bottom: 0.75rem; }
    .modal-actions { text-align: right; }

    .recipe-checkbox-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recipe-checkbox-list li {
      margin-bottom: 0.3rem;
      font-size: 0.95rem;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    /* LISTA DE COMPRAS */
    #shoppingListContainer {
      font-size: 0.95rem;
    }

    .shopping-recipe-block {
      border-top: 1px solid var(--border);
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }

    .shopping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
    }

    .shopping-header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .shopping-recipe-block ul {
      margin: 0.2rem 0 0.4rem;
      padding-left: 0;
      list-style: none;
    }

    .shopping-recipe-block li {
      margin-bottom: 0.2rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .shopping-recipe-block label {
      margin: 0;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .shopping-recipe-block span[contenteditable="true"] {
      outline: none;
      border-radius: 4px;
      padding: 0 2px;
      min-width: 40px;
    }

    .shopping-recipe-block .btn.sm {
      padding-inline: 0.4rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top-header">
      <div>
        <h1>CardÃ¡pio</h1>
        <div class="subtitle">
          SugestÃµes de refeiÃ§Ã£o respeitando glicemia e inflamaÃ§Ã£o.
        </div>
      </div>

      <div class="top-actions nav-row">
        <button type="button" class="btn pill-btn" onclick="window.location.href='index.html'" title="InÃ­cio">
          <span class="icon">ğŸ </span> InÃ­cio
        </button>
        <button id="btnBackupExport" class="btn pill-btn" type="button" title="Baixar um arquivo com seus dados">
          <span class="icon">ğŸ“¤</span> Backup
        </button>
        <button id="btnBackupImport" class="btn pill-btn" type="button" title="Restaurar dados a partir de um arquivo">
          <span class="icon">ğŸ“¥</span> Restaurar
        </button>
        <input id="backupFile" type="file" accept="application/json" style="display:none" />
      </div>
      <div class="tabs header-tabs">
        <button class="tab-btn active" data-tab="tabSugestoes">âœ¨ Filtro</button>
        <button class="tab-btn" data-tab="tabSemana">ğŸ“… Dia</button>
        <button class="tab-btn" data-tab="tabCompras">ğŸ›’ Lista de compras</button>
      </div>
    </header>

    <!-- TAB SUGESTÃ•ES (Filtro) -->
    <section id="tabSugestoes" class="tab-panel active">
      <div class="card">
        <div class="card-header">
          <h2>âœ¨ Filtro</h2>
        </div>

        <p class="small" id="suggestContextText">
          Usando: Dia 1 (Seg) â€¢ ğŸ› AlmoÃ§o
        </p>

        <div class="toolbar">
          <div style="min-width:150px;">
            <label class="small" for="suggestProtein">ProteÃ­na principal</label>
            <select id="suggestProtein">
              <option value="tanto-faz">Tanto faz</option>
              <option value="frango">ğŸ— Frango</option>
              <option value="boi">ğŸ¥© Boi</option>
              <option value="porco">ğŸ– Porco</option>
              <option value="peixe">ğŸŸ Peixe</option>
              <option value="ovo">ğŸ¥š Ovo</option>
              <option value="laticinio">ğŸ§€ LaticÃ­nios</option>
              <option value="veg">ğŸ¥¦ Veg</option>
            </select>
          </div>

          <div style="min-width:150px;">
            <label for="suggestWork">Tipo de refeiÃ§Ã£o</label>
            <select id="suggestWork">
              <option value="tanto-faz">Tanto faz</option>
              <option value="principal">ğŸ½ RefeiÃ§Ã£o principal</option>
              <option value="cafe">â˜• CafÃ©</option>
              <option value="sobremesa">ğŸ° Sobremesa</option>
              <option value="lanche">â˜€ï¸ Lanche</option>
              <option value="ceia">ğŸŒ’ Ceia</option>
              <option value="petisco">ğŸ· Petisco</option>
              <option value="salada">ğŸ¥— Salada</option>
              <option value="molho">ğŸ¥£ Molho</option>
              <option value="tempero">ğŸ§‚ Tempero</option>
            </select>
          </div>

          <div style="min-width:150px;">
            <label class="small" for="suggestKind">Tipo de receita</label>
            <select id="suggestKind">
              <option value="tanto-faz">Tanto faz</option>
              <option value="salgado">Salgado</option>
              <option value="doce">Doce</option>
            </select>
          </div>
        </div>

        <div class="toolbar">
          <label class="small">
            <input type="checkbox" id="suggestFavOnly" />
            â­ Priorizar favoritas
          </label>
          <label class="small">
            <input type="checkbox" id="suggestAvoidRecent" checked />
            ğŸ” Evitar repetir Ãºltimos dias
          </label>
        </div>

        <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
          <button class="btn primary" id="btnMostrarTudo" type="button">ğŸ‘€ Mostrar tudo</button>
          <button class="btn sm" id="btnTenhoIngredientes">ğŸ§º Tenho esses ingredientes</button>
          <button class="btn primary" id="btnNovaReceita" type="button">â• Nova receita</button>
        </div>

        <div id="suggestionsContainer" style="margin-top:0.75rem;"></div>
      </div>
      <div class="card" id="recipeFormCard" style="display:none;">
        <div class="card-header">
          <h2 id="recipeFormTitle">Nova receita</h2>
        </div>
        <form id="recipeForm">
          <label for="recipeName">Nome da receita</label>
          <input type="text" id="recipeName" required />

          <div class="field-row">
            <div>
              <label for="recipeKind">Tipo de receita</label>
              <select id="recipeKind" required>
                <option value="salgado">Salgado</option>
                <option value="doce">Doce</option>
              </select>
            </div>
            <div>
              <label for="recipeWork">Tipo de refeiÃ§Ã£o</label>
              <select id="recipeWork" required>
                <option value="principal">ğŸ½ RefeiÃ§Ã£o principal</option>
                <option value="cafe">â˜• CafÃ©</option>
                <option value="sobremesa">ğŸ° Sobremesa</option>
                <option value="lanche">â˜€ï¸ Lanche</option>
                <option value="ceia">ğŸŒ’ Ceia</option>
                <option value="petisco">ğŸ· Petisco</option>
                <option value="salada">ğŸ¥— Salada</option>
                <option value="molho">ğŸ¥£ Molho</option>
                <option value="tempero">ğŸ§‚ Tempero</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <div>
              <label for="recipeProtein">ProteÃ­na principal</label>
              <select id="recipeProtein" required>
                <option value="frango">ğŸ— Frango</option>
                <option value="boi">ğŸ¥© Boi</option>
                <option value="porco">ğŸ– Porco</option>
                <option value="peixe">ğŸŸ Peixe</option>
                <option value="ovo">ğŸ¥š Ovo</option>
                <option value="laticinio">ğŸ§€ LaticÃ­nios</option>
                <option value="veg">ğŸ¥¦ Veg</option>
              </select>
            </div>
            <div>
              <label for="recipeServings">PorÃ§Ãµes (pessoas)</label>
              <input type="number" id="recipeServings" min="1" max="100" value="3" />
            </div>
          </div>

          <label for="recipeIngredients">Ingredientes (opcional)<br>
            <span class="small">Um por linha (ex.: "500 g de frango", "2 tomates"...)</span>
          </label>
          <textarea id="recipeIngredients"></textarea>

          <label for="recipeInstructions">Modo de preparo (opcional)</label>
          <textarea id="recipeInstructions"></textarea>

          <label for="recipeFavorite">â­ Favorita</label>
          <input type="checkbox" id="recipeFavorite" />

          <label for="recipeLink">Link da receita (opcional)</label>
          <input type="url" id="recipeLink" placeholder="youtube.com/..." />

          <label for="recipePhoto">Foto (opcional)</label>
          <input type="file" id="recipePhoto" accept="image/*" />

          <div style="margin-top:0.75rem; text-align:right;">
            <button type="button" class="btn" id="btnCancelarReceita">Cancelar</button>
            <button type="submit" class="btn primary">Salvar receita</button>
          </div>
        </form>
      </div>
    </section>

    <!-- TAB DIA -->
    <section id="tabSemana" class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h2>OpÃ§Ãµes do dia</h2>
        </div>

        <p class="small" id="diaIntroText">
          Monte o cardÃ¡pio dos dias (1 a 14) escolhendo o tipo de refeiÃ§Ã£o e adicionando as receitas.
        </p>

        <div style="margin-bottom:0.5rem;">
          <button class="btn sm" id="btnVerCalendario">ğŸ“† Ver em calendÃ¡rio semanal</button>
        </div>

        <p class="small">
          OpÃ§Ãµes do dia: monte o cardÃ¡pio dos 14 dias.
        </p>

        <div class="toolbar">
          <div style="min-width:140px;">
            <label for="weekSelect" class="small">Dia</label>
            <select id="weekSelect">
              <option value="0">Dia 1</option>
              <option value="1">Dia 2</option>
              <option value="2">Dia 3</option>
              <option value="3">Dia 4</option>
              <option value="4">Dia 5</option>
              <option value="5">Dia 6</option>
              <option value="6">Dia 7</option>
              <option value="7">Dia 8</option>
              <option value="8">Dia 9</option>
              <option value="9">Dia 10</option>
              <option value="10">Dia 11</option>
              <option value="11">Dia 12</option>
              <option value="12">Dia 13</option>
              <option value="13">Dia 14</option>
            </select>
          </div>

          <div style="min-width:80px;">
            <label class="small">Dia da semana</label>
            <div id="weekdayLabel" class="small" style="font-weight:600; margin-top:0.45rem;">
              <!-- preenchido via JS, ex.: QUI -->
            </div>
          </div>

          <div style="min-width:180px;">
            <label for="mealSelect" class="small">Tipo de refeiÃ§Ã£o em ediÃ§Ã£o</label>
            <select id="mealSelect">
              <option value="almoco">ğŸ› AlmoÃ§o</option>
              <option value="jantar">ğŸ½ Jantar</option>
              <option value="lanche">â˜• Lanches</option>
              <option value="petisco">ğŸ· Petiscos</option>
            </select>
          </div>

          <!-- NOVO: botÃ£o para abrir a Rotina jÃ¡ no mesmo dia -->
          <div style="min-width:160px;">
            <label class="small">&nbsp;</label>
            <button
              class="btn sm"
              id="btnOpenRotinaForDay"
              style="margin-top:0.45rem; width:100%;"
              type="button"
            >
              Abrir rotina do dia
            </button>
          </div>
        </div>

        <div class="week-block">
          <div class="section-title" id="currentMealTitle">OpÃ§Ãµes do dia</div>
          <div id="dayMealsContainer"></div>
          <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
            <button class="btn sm" id="btnEditCurrentMeal">Adicionar receitas ao tipo selecionado</button>
            <button class="btn sm danger" id="btnClearDay">Limpar tudo do dia</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB LISTA DE COMPRAS -->
    <section id="tabCompras" class="tab-panel">
      <div class="card">
        <div class="card-header">
          <h2>Lista de compras</h2>
        </div>

        <div class="toolbar">
          <button class="btn primary" id="btnGerarLista">Gerar lista geral</button>
          <button class="btn danger sm" id="btnClearShopping">Limpar tudo</button>
        </div>

        <p class="small">
          A lista Ã© separada por receita.
        </p>

        <div id="shoppingListContainer"></div>
      </div>
    </section>
  </div>

  <!-- MODAL GENÃ‰RICO -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <h2 id="modalTitle">Escolher receitas</h2>
      <div class="modal-content" id="modalContent"></div>
      <div class="modal-actions">
        <button class="btn" id="modalCancel">Cancelar</button>
        <button class="btn primary" id="modalSave">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL FOTO -->
  <div id="photoOverlay" class="modal-overlay">
    <div class="modal">
      <img id="photoOverlayImg" src="" alt="Foto da receita" />
    </div>
  </div>

  <!-- MODAL: CALENDÃRIO DO CARDÃPIO -->
  <div id="calendarOverlay" class="modal-overlay">
    <div class="modal">
      <h2>CalendÃ¡rio do cardÃ¡pio</h2>
      <div class="modal-content" id="calendarContent"></div>
      <div class="modal-actions">
        <button class="btn" id="calendarClose">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = "cardapioMaeState_v7";
      const FONT_KEY = "cardapioMaeFontSize";

      const WEEKDAYS_SHORT = ["Seg", "Ter", "Qua", "Qui", "Sex", "SÃ¡b", "Dom"];

      const INITIAL_RECIPES = [
        {
          "id": "recipe-1",
          "name": "Escondidinho de carne picada de peru",
          "receita": "salgado",
          "refeicao": "principal",
          "proteina": "frango",
          "ingredients": [
            "1 kg de batatas descascadas e cortadas em pedaÃ§os",
            "2 colheres de sopa de manteiga",
            "100 ml de leite (ou quanto baste)",
            "Sal e noz-moscada a gosto",
            "500 g de carne picada de peru",
            "1 cebola mÃ©dia, picada",
            "2 dentes de alho, picados",
            "1 tomate maduro picado (ou 100 g de polpa de tomate)",
            "1/2 pimento vermelho, picado (opcional)",
            "2 colheres de sopa de azeite",
            "1 colher de chÃ¡ de colorau ou pÃ¡prica doce",
            "Sal e pimenta-do-reino a gosto",
            "Salsa ou coentros frescos, picados (para finalizar)",
            "150 g de queijo mozarela ralado (ou queijo da sua preferÃªncia)"
          ],
          "instructions": "1) Cozinhe as batatas em Ã¡gua com uma pitada de sal atÃ© ficarem macias (cerca de 15â€“20 minutos). Escorra a Ã¡gua e amasse as batatas com um espremedor ou garfo. Adicione a manteiga e o leite aos poucos, mexendo atÃ© obter um purÃª cremoso. Tempere com sal e noz-moscada a gosto. Reserve.\n\n2) Numa frigideira grande, aqueÃ§a o azeite e refogue a cebola e o alho atÃ© ficarem macios. Junte a carne picada de peru e cozinhe atÃ© dourar. Adicione o tomate, o pimento (se for usar), o colorau, sal e pimenta. Cozinhe por mais cerca de 10 minutos, mexendo ocasionalmente, atÃ© o molho apurar. Finalize com salsa ou coentros picados.\n\n3) PrÃ©-aqueÃ§a o forno a 200 Â°C. Numa travessa grande, espalhe uma camada uniforme de purÃª de batata no fundo. Adicione o recheio de carne por cima e cubra com o restante purÃª, alisando a superfÃ­cie com uma espÃ¡tula.\n\n4) Polvilhe o queijo ralado sobre o purÃª.\n\n5) Leve ao forno por cerca de 20 minutos, ou atÃ© o queijo derreter e dourar levemente.\n\n6) Retire do forno, deixe descansar por 5 minutos e sirva quente.",
          "favorite": false,
          "photo": null,
          "link": "https://cookpad.com/pt/receitas/24346747"
        },
        {
          "id": "r2",
          "name": "PÃƒO DE CEBOLA FOFINHO E SUPER FÃCIL DE FAZER",
          "receita": "salgado",
          "refeicao": "lanche",
          "proteina": "veg",
          "ingredients": [
            "grÃ£o de bico cru com pele",
            "1 folha de louro",
            "1 dente de alho",
            "sal ",
            "2 unidades ovos",
            "1 unidade grande cebola picada",
            "meia xÃ­cara de chÃ¡ Ã³leo",
            "2 colheres de chÃ¡ sal",
            "6 xÃ­caras de chÃ¡ farinha de trigo",
            "1 xÃ­cara de chÃ¡ leite morno",
            "2 tabletes fermento biolÃ³gico",
            "1 unidade gema de ovo"
          ],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/QLuoU5eTu58?si=Ilk4S1vM_g7zCIe6"
        },
        {
          "id": "r3",
          "name": "COOKIES DE AVEIA E BANANA ğŸª",
          "receita": "salgado",
          "refeicao": "lanche",
          "proteina": "veg",
          "ingredients": [
            "3 bananas maduras amassadas",
            "3 colheres de sopa Ã³leo de coco",
            "1 xÃ­cara de aveia em flocos",
            "1/2 xÃ­cara farinha de aveia",
            "1/2 xÃ­cara uvas passas",
            "canela a gosto"
          ],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/DlC4JaxkKjI?si=C0--QIRTlg0UvgC1"
        },
        {
          "id": "r4",
          "name": "Trufas de tÃ¢maras ğŸ§†",
          "receita": "doce",
          "refeicao": "lanche",
          "proteina": "veg",
          "ingredients": [
            "500g de tÃ¢maras sem caroÃ§o",
            "200g de oleaginosas (castanha de caju ou parÃ¡, nozes, etc.)",
            "3 colheres (sopa) cacau em pÃ³",
            "1 pitada de sal"
          ],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/gKsy_BjD0Vc?si=56Bi2m0BMun44990"
        },
        {
          "id": "r5",
          "name": "Bolo de iogurte proteico ğŸ§",
          "receita": "doce",
          "refeicao": "lanche",
          "proteina": "ovo",
          "ingredients": [
            "1 xÃ­cara farinha de aveia",
            "1 xÃ­cara farinha de amÃªndoas",
            "4 colheres adoÃ§ante xilitol",
            "1 colher (sopa) fermento",
            "4 ovos",
            "170g de iogurte grego (1 pote)",
            "1 colher (chÃ¡) canela",
            "1 maÃ§Ã£ picada",
            "1/4 xÃ­cara Ã³leo de coco"
          ],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/vpT_id4h9Lg?si=f3WvNSk7UBJorqW1"
        },
        {
          "id": "r6",
          "name": "Cookies 3 ingredientes ğŸª",
          "receita": "doce",
          "refeicao": "lanche",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/XFB1RGqrq1o?si=bv3XJnUrVykby3wy"
        },
        {
          "id": "r7",
          "name": "Biscoitinhos de coco com goiabada",
          "receita": "doce",
          "refeicao": "cafe",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://catracalivre.com.br/gastronomia/biscoito-de-coco-vegano-para-comer-com-aquele-cafezinho/"
        },
        {
          "id": "r8",
          "name": "Bolo pÃ© de moleque de liquidificador",
          "receita": "salgado",
          "refeicao": "sobremesa",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/30VuwX-67Nk?si=JXAVDeeDTGuVeIYj"
        },
        {
          "id": "r9",
          "name": "Torta de sardinha ğŸ¥§",
          "receita": "salgado",
          "refeicao": "lanche",
          "proteina": "peixe",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://www.nit.pt/fit/este-bolo-de-maca-delicioso-e-sem-gluten-prepara-se-em-10-minutos"
        },
        {
          "id": "r10",
          "name": "Bolo de fubÃ¡ de vÃ³",
          "receita": "salgado",
          "refeicao": "sobremesa",
          "proteina": "ovo",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://youtu.be/FdEBfu9P8MU?si=6q4k1Eh9hqMy8BuQ"
        },
        {
          "id": "r11",
          "name": "Bolo de aipim cremoso",
          "receita": "salgado",
          "refeicao": "sobremesa",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://comidinhasdochef.com/bolo-cremoso-de-aipim/"
        },
        {
          "id": "r12",
          "name": "Bolo de banana fit sem farinha",
          "receita": "doce",
          "refeicao": "cafe",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://catracalivre.com.br/gastronomia/bolo-de-banana-com-aveia-e-sem-farinha-trigo/"
        },
        {
          "id": "r13",
          "name": "Bolo centenÃ¡rio das avÃ³s italianas ğŸ°",
          "receita": "doce",
          "refeicao": "sobremesa",
          "proteina": "ovo",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://www.tudogostoso.com.br/noticias/nem-farinha-nem-fermento-um-bolo-muito-fofo-feito-pelas-avos-italianas-e-sua-receita-centenaria-saiba-"
        },
        {
          "id": "r14",
          "name": "Bolo de chocolate de liquidificador",
          "receita": "salgado",
          "refeicao": "sobremesa",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": "https://receitasdepesos.com.br/receitas/2020/12/19/esse-bolo-chocolate-de-liquidificador-molhadinho-e-muito-facil-de-fazer/"
        },
        {
          "id": "r15",
          "name": "Mousse de manga 3 ingredientes",
          "receita": "doce",
          "refeicao": "sobremesa",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": ""
        },
        {
          "id": "r16",
          "name": "Sorvete caseiro de morango ğŸ¨",
          "receita": "doce",
          "refeicao": "sobremesa",
          "proteina": "laticinio",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": null
        },
        {
          "id": "r17",
          "name": "Sorvete fÃ¡cil de maracujÃ¡ ğŸ¨",
          "receita": "doce",
          "refeicao": "sobremesa",
          "proteina": "laticinio",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": ""
        },
        {
          "id": "r18",
          "name": "Sorvete fit de banana com pasta de amendoim ğŸŒ",
          "receita": "doce",
          "refeicao": "sobremesa",
          "proteina": "veg",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": ""
        },
        {
          "id": "r19",
          "name": "Vitamina de abacate ğŸ¥‘",
          "receita": "doce",
          "refeicao": "lanche",
          "proteina": "laticinio",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": ""
        },
        {
          "id": "r20",
          "name": "Vitamina de frutas vermelhas",
          "receita": "doce",
          "refeicao": "lanche",
          "proteina": "laticinio",
          "ingredients": [],
          "instructions": "",
          "favorite": false,
          "photo": null,
          "link": ""
        }
      ];

      const INITIAL_WEEKLY_PLANS = new Array(14).fill(null).map(() => ({
        almoco: [],
        jantar: [],
        lanche: [],
        petisco: []
      }));

      // Le estado salvo no localStorage ou usa os dados iniciais
      let state = {};
      try {
        const savedState = localStorage.getItem(STORAGE_KEY);
        state = savedState ? JSON.parse(savedState) : {};
      } catch(e) {
        state = {};
      }
      if (!state.recipes) {
        state.recipes = INITIAL_RECIPES;
      }
      if (!state.weeklyPlans) {
        state.weeklyPlans = INITIAL_WEEKLY_PLANS;
      }
      if (!state.selectedWeekIndex) {
        state.selectedWeekIndex = 0;
      }
      if (!state.recipeStats) {
        state.recipeStats = {};
      }
      if (!state.mealCompliance) {
        state.mealCompliance = {};
      }
      if (!state.rotinaConfig) {
        state.rotinaConfig = { dayIndex: 0, times: {} };
      }
      // Tamanho da fonte (persistido separadamente)
      try {
        const savedFontSize = localStorage.getItem(FONT_KEY);
        if (savedFontSize) {
          document.documentElement.style.fontSize = savedFontSize;
        }
      } catch(e) {}

      // ReferÃªncias aos elementos da UI
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const targetId = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.remove("active"));
          tabPanels.forEach(p => p.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(targetId).classList.add("active");
        });
      });

      const recipesListEl = document.getElementById("recipesList");
      const btnNovaReceita = document.getElementById("btnNovaReceita");
      const recipeFormCard = document.getElementById("recipeFormCard");
      const recipeForm = document.getElementById("recipeForm");
      const recipeFormTitle = document.getElementById("recipeFormTitle");
      const btnCancelarReceita = document.getElementById("btnCancelarReceita");

      const fieldName = document.getElementById("recipeName");
      const fieldKind = document.getElementById("recipeKind");
      const fieldWork = document.getElementById("recipeWork");
      const fieldServings = document.getElementById("recipeServings");
      const fieldProtein = document.getElementById("recipeProtein");
      const fieldIngredients = document.getElementById("recipeIngredients");
      const fieldInstructions = document.getElementById("recipeInstructions");
      const fieldPhoto = document.getElementById("recipePhoto");
      const fieldLink = document.getElementById("recipeLink");
      const fieldFavorite = document.getElementById("recipeFavorite");

      const filterFav = document.getElementById("filterFav");
      const recipeSearch = document.getElementById("recipeSearch");

      const photoOverlay = document.getElementById("photoOverlay");
      const photoOverlayImg = document.getElementById("photoOverlayImg");

      let currentEditingRecipeId = null;

      function openPhoto(src, alt) {
        if (!src) return;
        photoOverlayImg.src = src;
        photoOverlayImg.alt = alt || "Foto da receita";
        photoOverlay.classList.add("active");
      }

      if (photoOverlay) {
        photoOverlay.addEventListener("click", () => {
          photoOverlay.classList.remove("active");
        });
      }

      function renderRecipesList() {
        recipesListEl.innerHTML = "";

        if (!state.recipes.length) {
          const p = document.createElement("p");
          p.className = "small";
          p.textContent = "Nenhuma receita cadastrada ainda. Clique em â€œNova receitaâ€ para comeÃ§ar.";
          recipesListEl.appendChild(p);
          return;
        }

        const fFilter = filterFav ? filterFav.value : "";
        const searchTerm = recipeSearch.value.trim().toLowerCase();

        const filtered = state.recipes.filter(r => {
          if (fFilter === "salgado" && r.kind !== "salgado") return false;
          if (fFilter === "doce" && r.kind !== "doce") return false;
          if (fFilter === "fav" && !r.favorite) return false;

          const ingredientsText = Array.isArray(r.ingredients)
            ? r.ingredients.join(" ")
            : (r.ingredients || "");
          if (searchTerm) {
            const haystack =
              (r.name || "") + " " +
              ingredientsText + " " +
              (r.instructions || "") + " " +
              (r.link || "") + " " +
              (r.kind || "");
            if (!haystack.toLowerCase().includes(searchTerm)) return false;
          }

          return true;
        });

        if (!filtered.length) {
          const p = document.createElement("p");
          p.className = "small";
          p.textContent = "Nenhuma receita encontrado com esses filtros ou busca.";
          recipesListEl.appendChild(p);
          return;
        }

        filtered.forEach(r => {
          const card = document.createElement("div");
          card.className = "recipe-card";

          const top = document.createElement("div");
          top.className = "recipe-top";

          if (r.photo) {
            const img = document.createElement("img");
            img.className = "recipe-photo";
            img.src = r.photo;
            img.alt = r.name;
            img.addEventListener("click", () => openPhoto(r.photo, r.name));
            top.appendChild(img);
          }

          const main = document.createElement("div");
          main.className = "recipe-main";

          const nameEl = document.createElement("div");
          nameEl.className = "recipe-name";
          nameEl.textContent = r.name;

          const metaEl = document.createElement("div");
          metaEl.className = "recipe-meta";
          metaEl.textContent =
            kindLabel(r.kind) + " â€¢ " +
            workLevelLabel(r.work) +
            (r.servings ? " â€¢ " + r.servings + " porÃ§Ãµes" : "");

          main.appendChild(nameEl);
          main.appendChild(metaEl);

          if (r.link) {
            const linkRow = document.createElement("div");
            linkRow.className = "recipe-link-inline small";
            const a = document.createElement("a");
            a.href = normalizeLink(r.link);
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "ğŸ”— Abrir receita";
            linkRow.appendChild(a);
            main.appendChild(linkRow);
          }

          top.appendChild(main);

          const actions = document.createElement("div");
          actions.className = "recipe-actions";

          const detailsBtn = document.createElement("button");
          detailsBtn.className = "btn sm";
          detailsBtn.dataset.action = "details";
          detailsBtn.dataset.id = r.id;
          detailsBtn.textContent = "ğŸ™ˆ";

          const favBtn = document.createElement("button");
          favBtn.className = "btn sm";
          favBtn.dataset.action = "fav";
          favBtn.dataset.id = r.id;
          favBtn.textContent = r.favorite ? "â­ï¸" : "â˜†";

          const addDayBtn = document.createElement("button");
          addDayBtn.className = "btn sm";
          addDayBtn.dataset.action = "add-to-day";
          addDayBtn.dataset.id = r.id;
          addDayBtn.textContent = "ğŸ“…";

          const editBtn = document.createElement("button");
          editBtn.className = "btn sm";
          editBtn.dataset.action = "edit";
          editBtn.dataset.id = r.id;
          editBtn.textContent = "âœï¸";

          const delBtn = document.createElement("button");
          delBtn.className = "btn sm danger";
          delBtn.dataset.action = "delete";
          delBtn.dataset.id = r.id;
          delBtn.textContent = "ğŸ—‘";

          actions.appendChild(detailsBtn);
          actions.appendChild(favBtn);
          actions.appendChild(addDayBtn);
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          const details = document.createElement("div");
          details.className = "recipe-details";

          if (r.ingredients && r.ingredients.length) {
            const sectionTitle = document.createElement("div");
            sectionTitle.className = "section-title";
            sectionTitle.textContent = "ğŸ“ Ingredientes";
            details.appendChild(sectionTitle);

            const ul = document.createElement("ul");
            r.ingredients.forEach(item => {
              const li = document.createElement("li");
              li.textContent = item;
              ul.appendChild(li);
            });
            details.appendChild(ul);
          }

          if (r.instructions) {
            const sectionTitle = document.createElement("div");
            sectionTitle.className = "section-title";
            sectionTitle.textContent = "ğŸ“– Modo de preparo";
            details.appendChild(sectionTitle);

            const p = document.createElement("p");
            p.textContent = r.instructions;
            details.appendChild(p);
          }

          top.appendChild(details);

          card.appendChild(top);
          card.appendChild(actions);
          card.appendChild(details);

          recipesListEl.appendChild(card);
        });
      }

      const suggestContextText = document.getElementById("suggestContextText");
      const suggestProtein = document.getElementById("suggestProtein");
      const suggestWork = document.getElementById("suggestWork");
      const suggestKind = document.getElementById("suggestKind");
      const suggestFavOnly = document.getElementById("suggestFavOnly");
      const suggestAvoidRecent = document.getElementById("suggestAvoidRecent");
      const btnMostrarTudo = document.getElementById("btnMostrarTudo");

      const btnGerarSugestoes = document.getElementById("btnGerarSugestoes");
      const btnVisitasEmCasa = document.getElementById("btnVisitasEmCasa");
      const btnTenhoIngredientes = document.getElementById("btnTenhoIngredientes");

      function readFiltersFromUI() {
        const kindFilter = (suggestKind && suggestKind.value) ? suggestKind.value : "tanto-faz";
        const workFilter = (suggestWork && suggestWork.value) ? suggestWork.value : "tanto-faz";
        const proteinFilter = (suggestProtein && suggestProtein.value) ? suggestProtein.value : "tanto-faz";
        // NÃ£o hÃ¡ filtro de tempo na UI desta versÃ£o
        const timeFilter = "tanto-faz";
        // MantÃ©m compatibilidade com versÃµes antigas (poderia ser usado como atalho)
        const avoidSweets = false;
        return { kindFilter, workFilter, timeFilter, proteinFilter, avoidSweets };
      }

      const suggestionsContainer = document.getElementById("suggestionsContainer");

      if (btnMostrarTudo) {
        btnMostrarTudo.addEventListener("click", () => {
          // mostra TODAS as receitas que batem com os filtros escolhidos na aba âœ¨Filtro
          lastSuggestionIgnoredIds = [];
          generateSuggestionsNow({ extraMode: "filtrar", maxResults: 999 });
        });
      }

      // guarda ids de receitas recusadas na rodada atual
      let lastSuggestionIgnoredIds = [];

      // EstatÃ­sticas por receita
      function getRecipeStats(id) {
        if (!state.recipeStats || typeof state.recipeStats !== "object") {
          state.recipeStats = {};
        }
        if (!state.recipeStats[id]) {
          state.recipeStats[id] = {
            usedCount: 0,
            rejectedCount: 0,
            lastUsedDay: null
          };
        }
        return state.recipeStats[id];
      }

      function updateSuggestContextText() {
        if (!suggestContextText) return;
        const dayIdx = state.selectedWeekIndex || 0;
        const dayNumber = dayIdx + 1;
        const wd = weekdayForDayIndex(dayIdx);
        const mealName = mealLabel(currentMealType);
        suggestContextText.textContent = `Usando: Dia ${dayNumber} (${wd}) â€¢ ${mealName}`;
      }

      // ==== CALENDÃRIO DO CARDÃPIO ====
      const btnVerCalendario = document.getElementById("btnVerCalendario");
      const calendarOverlay = document.getElementById("calendarOverlay");
      const calendarContent = document.getElementById("calendarContent");
      const calendarClose = document.getElementById("calendarClose");

      const calendarMealTypes = ["almoco", "lanche", "jantar", "petisco"];

      function buildDayMealsText(dayPlan) {
        const lines = [];

        calendarMealTypes.forEach(mt => {
          const ids = dayPlan[mt] || [];
          if (!ids.length) return;

          let label = "";
          if (mt === "almoco") label = "AlmoÃ§o";
          if (mt === "lanche") label = "Lanche";
          if (mt === "jantar") label = "Jantar";
          if (mt === "petisco") label = "Petisco";

          const names = ids.map(id => {
            const r = state.recipes.find(x => x.id === id);
            return r ? r.name : "(removida)";
          });
          lines.push(`${label}: ${names.join(" + ")}`);
        });

        return lines.join("\n");
      }

      if (btnVerCalendario) {
        btnVerCalendario.addEventListener("click", () => {
          if (!state.weeklyPlans || !Array.isArray(state.weeklyPlans)) return;
          const lines = state.weeklyPlans.map((wp, idx) => {
            const dayText = buildDayMealsText(wp);
            if (!dayText) return null;
            const dayNumber = idx + 1;
            const wd = weekdayForDayIndex(idx);
            return `Dia ${dayNumber} (${wd})\n${dayText}`;
          }).filter(Boolean);
          if (!lines.length) {
            alert("Nenhuma refeiÃ§Ã£o planejada ainda.");
            return;
          }
          calendarContent.textContent = lines.join("\n\n");
          calendarOverlay.classList.add("active");
        });
      }
      if (calendarClose) {
        calendarClose.addEventListener("click", () => {
          calendarOverlay.classList.remove("active");
        });
      }

      // Rotina - abrir no dia especÃ­fico
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");
      if (btnOpenRotinaForDay) {
        btnOpenRotinaForDay.addEventListener("click", () => {
          if (state.selectedWeekIndex != null) {
            try {
              localStorage.setItem("selectedWeekIndexRotina", String(state.selectedWeekIndex));
            } catch (e) {}
          }
          window.location.href = "rotina.html";
        });
      }

      // ==== OPÃ‡Ã•ES DO DIA ====
      const weekSelect = document.getElementById("weekSelect");
      const mealSelect = document.getElementById("mealSelect");
      const startWeekdaySelect = document.getElementById("startWeekdaySelect");
      const currentMealTitle = document.getElementById("currentMealTitle");
      const dayMealsContainer = document.getElementById("dayMealsContainer");
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");

      const btnEditCurrentMeal = document.getElementById("btnEditCurrentMeal");
      const btnClearDay = document.getElementById("btnClearDay");
      const weekdayLabel = document.getElementById("weekdayLabel");

      // ===== SUGESTÃ•ES â€“ ELEMENTOS DA TELA =====
      const suggestContextText = document.getElementById("suggestContextText");
      const suggestProtein = document.getElementById("suggestProtein");
      const suggestWork = document.getElementById("suggestWork");
      const suggestKind = document.getElementById("suggestKind");
      const suggestFavOnly = document.getElementById("suggestFavOnly");
      const suggestAvoidRecent = document.getElementById("suggestAvoidRecent");
      const btnMostrarTudo = document.getElementById("btnMostrarTudo");

      const btnGerarSugestoes = document.getElementById("btnGerarSugestoes");
      const btnVisitasEmCasa = document.getElementById("btnVisitasEmCasa");
      const btnTenhoIngredientes = document.getElementById("btnTenhoIngredientes");

      function readFiltersFromUI() {
        const kindFilter = (suggestKind && suggestKind.value) ? suggestKind.value : "tanto-faz";
        const workFilter = (suggestWork && suggestWork.value) ? suggestWork.value : "tanto-faz";
        const proteinFilter = (suggestProtein && suggestProtein.value) ? suggestProtein.value : "tanto-faz";
        // NÃ£o hÃ¡ filtro de tempo na UI desta versÃ£o
        const timeFilter = "tanto-faz";
        // MantÃ©m compatibilidade com versÃµes antigas (poderia ser usado como atalho)
        const avoidSweets = false;
        return { kindFilter, workFilter, timeFilter, proteinFilter, avoidSweets };
      }

      const suggestionsContainer = document.getElementById("suggestionsContainer");

      if (btnMostrarTudo) {
        btnMostrarTudo.addEventListener("click", () => {
          // mostra TODAS as receitas que batem com os filtros escolhidos na aba âœ¨Filtro
          lastSuggestionIgnoredIds = [];
          generateSuggestionsNow({ extraMode: "filtrar", maxResults: 999 });
        });
      }

      // guarda ids de receitas recusadas na rodada atual
      let lastSuggestionIgnoredIds = [];

      // EstatÃ­sticas por receita
      function getRecipeStats(id) {
        if (!state.recipeStats || typeof state.recipeStats !== "object") {
          state.recipeStats = {};
        }
        if (!state.recipeStats[id]) {
          state.recipeStats[id] = {
            usedCount: 0,
            rejectedCount: 0,
            lastUsedDay: null
          };
        }
        return state.recipeStats[id];
      }

      function updateSuggestContextText() {
        if (!suggestContextText) return;
        const dayIdx = state.selectedWeekIndex || 0;
        const dayNumber = dayIdx + 1;
        const wd = weekdayForDayIndex(dayIdx);
        const mealName = mealLabel(currentMealType);
        suggestContextText.textContent = `Usando: Dia ${dayNumber} (${wd}) â€¢ ${mealName}`;
      }

      // ==== CALENDÃRIO DO CARDÃPIO ====
      const btnVerCalendario = document.getElementById("btnVerCalendario");
      const calendarOverlay = document.getElementById("calendarOverlay");
      const calendarContent = document.getElementById("calendarContent");
      const calendarClose = document.getElementById("calendarClose");

      const calendarMealTypes = ["almoco", "lanche", "jantar", "petisco"];

      function buildDayMealsText(dayPlan) {
        const lines = [];

        calendarMealTypes.forEach(mt => {
          const ids = dayPlan[mt] || [];
          if (!ids.length) return;

          let label = "";
          if (mt === "almoco") label = "AlmoÃ§o";
          if (mt === "lanche") label = "Lanche";
          if (mt === "jantar") label = "Jantar";
          if (mt === "petisco") label = "Petisco";

          const names = ids.map(id => {
            const r = state.recipes.find(x => x.id === id);
            return r ? r.name : "(removida)";
          });
          lines.push(`${label}: ${names.join(" + ")}`);
        });

        return lines.join("\n");
      }

      if (btnVerCalendario) {
        btnVerCalendario.addEventListener("click", () => {
          if (!state.weeklyPlans || !Array.isArray(state.weeklyPlans)) return;
          const lines = state.weeklyPlans.map((wp, idx) => {
            const dayText = buildDayMealsText(wp);
            if (!dayText) return null;
            const dayNumber = idx + 1;
            const wd = weekdayForDayIndex(idx);
            return `Dia ${dayNumber} (${wd})\n${dayText}`;
          }).filter(Boolean);
          if (!lines.length) {
            alert("Nenhuma refeiÃ§Ã£o planejada ainda.");
            return;
          }
          calendarContent.textContent = lines.join("\n\n");
          calendarOverlay.classList.add("active");
        });
      }
      if (calendarClose) {
        calendarClose.addEventListener("click", () => {
          calendarOverlay.classList.remove("active");
        });
      }

      // Rotina - abrir no dia especÃ­fico
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");
      if (btnOpenRotinaForDay) {
        btnOpenRotinaForDay.addEventListener("click", () => {
          if (state.selectedWeekIndex != null) {
            try {
              localStorage.setItem("selectedWeekIndexRotina", String(state.selectedWeekIndex));
            } catch (e) {}
          }
          window.location.href = "rotina.html";
        });
      }

      // ==== OPÃ‡Ã•ES DO DIA ====
      const weekSelect = document.getElementById("weekSelect");
      const mealSelect = document.getElementById("mealSelect");
      const startWeekdaySelect = document.getElementById("startWeekdaySelect");
      const currentMealTitle = document.getElementById("currentMealTitle");
      const dayMealsContainer = document.getElementById("dayMealsContainer");
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");

      const btnEditCurrentMeal = document.getElementById("btnEditCurrentMeal");
      const btnClearDay = document.getElementById("btnClearDay");
      const weekdayLabel = document.getElementById("weekdayLabel");

      // ===== SUGESTÃ•ES â€“ ELEMENTOS DA TELA =====
      const suggestContextText = document.getElementById("suggestContextText");
      const suggestProtein = document.getElementById("suggestProtein");
      const suggestWork = document.getElementById("suggestWork");
      const suggestKind = document.getElementById("suggestKind");
      const suggestFavOnly = document.getElementById("suggestFavOnly");
      const suggestAvoidRecent = document.getElementById("suggestAvoidRecent");
      const btnMostrarTudo = document.getElementById("btnMostrarTudo");

      const btnGerarSugestoes = document.getElementById("btnGerarSugestoes");
      const btnVisitasEmCasa = document.getElementById("btnVisitasEmCasa");
      const btnTenhoIngredientes = document.getElementById("btnTenhoIngredientes");

      function readFiltersFromUI() {
        const kindFilter = (suggestKind && suggestKind.value) ? suggestKind.value : "tanto-faz";
        const workFilter = (suggestWork && suggestWork.value) ? suggestWork.value : "tanto-faz";
        const proteinFilter = (suggestProtein && suggestProtein.value) ? suggestProtein.value : "tanto-faz";
        // NÃ£o hÃ¡ filtro de tempo na UI desta versÃ£o
        const timeFilter = "tanto-faz";
        // MantÃ©m compatibilidade com versÃµes antigas (poderia ser usado como atalho)
        const avoidSweets = false;
        return { kindFilter, workFilter, timeFilter, proteinFilter, avoidSweets };
      }

      const suggestionsContainer = document.getElementById("suggestionsContainer");

      if (btnMostrarTudo) {
        btnMostrarTudo.addEventListener("click", () => {
          // mostra TODAS as receitas que batem com os filtros escolhidos na aba âœ¨Filtro
          lastSuggestionIgnoredIds = [];
          generateSuggestionsNow({ extraMode: "filtrar", maxResults: 999 });
        });
      }

      // guarda ids de receitas recusadas na rodada atual
      let lastSuggestionIgnoredIds = [];

      // EstatÃ­sticas por receita
      function getRecipeStats(id) {
        if (!state.recipeStats || typeof state.recipeStats !== "object") {
          state.recipeStats = {};
        }
        if (!state.recipeStats[id]) {
          state.recipeStats[id] = {
            usedCount: 0,
            rejectedCount: 0,
            lastUsedDay: null
          };
        }
        return state.recipeStats[id];
      }

      function updateSuggestContextText() {
        if (!suggestContextText) return;
        const dayIdx = state.selectedWeekIndex || 0;
        const dayNumber = dayIdx + 1;
        const wd = weekdayForDayIndex(dayIdx);
        const mealName = mealLabel(currentMealType);
        suggestContextText.textContent = `Usando: Dia ${dayNumber} (${wd}) â€¢ ${mealName}`;
      }

      // ==== CALENDÃRIO DO CARDÃPIO ====
      const btnVerCalendario = document.getElementById("btnVerCalendario");
      const calendarOverlay = document.getElementById("calendarOverlay");
      const calendarContent = document.getElementById("calendarContent");
      const calendarClose = document.getElementById("calendarClose");

      const calendarMealTypes = ["almoco", "lanche", "jantar", "petisco"];

      function buildDayMealsText(dayPlan) {
        const lines = [];

        calendarMealTypes.forEach(mt => {
          const ids = dayPlan[mt] || [];
          if (!ids.length) return;

          let label = "";
          if (mt === "almoco") label = "AlmoÃ§o";
          if (mt === "lanche") label = "Lanche";
          if (mt === "jantar") label = "Jantar";
          if (mt === "petisco") label = "Petisco";

          const names = ids.map(id => {
            const r = state.recipes.find(x => x.id === id);
            return r ? r.name : "(removida)";
          });
          lines.push(`${label}: ${names.join(" + ")}`);
        });

        return lines.join("\n");
      }

      if (btnVerCalendario) {
        btnVerCalendario.addEventListener("click", () => {
          if (!state.weeklyPlans || !Array.isArray(state.weeklyPlans)) return;
          const lines = state.weeklyPlans.map((wp, idx) => {
            const dayText = buildDayMealsText(wp);
            if (!dayText) return null;
            const dayNumber = idx + 1;
            const wd = weekdayForDayIndex(idx);
            return `Dia ${dayNumber} (${wd})\n${dayText}`;
          }).filter(Boolean);
          if (!lines.length) {
            alert("Nenhuma refeiÃ§Ã£o planejada ainda.");
            return;
          }
          calendarContent.textContent = lines.join("\n\n");
          calendarOverlay.classList.add("active");
        });
      }
      if (calendarClose) {
        calendarClose.addEventListener("click", () => {
          calendarOverlay.classList.remove("active");
        });
      }

      // Rotina - abrir no dia especÃ­fico
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");
      if (btnOpenRotinaForDay) {
        btnOpenRotinaForDay.addEventListener("click", () => {
          if (state.selectedWeekIndex != null) {
            try {
              localStorage.setItem("selectedWeekIndexRotina", String(state.selectedWeekIndex));
            } catch (e) {}
          }
          window.location.href = "rotina.html";
        });
      }

      // FunÃ§Ãµes auxiliares (labels, normalizaÃ§Ã£o de links etc.) â€“ permanecem inalteradas
      function mealLabel(meal) {
        if (meal === "almoco") return "ğŸ› AlmoÃ§o";
        if (meal === "jantar") return "ğŸ½ Jantar";
        if (meal === "lanche") return "â˜• Lanche";
        if (meal === "petisco") return "ğŸ· Petisco";
        return meal;
      }

      function kindLabel(kind) {
        if (kind === "salgado") return "Salgado";
        if (kind === "doce") return "Doce";
        return kind;
      }

      function workLevelLabel(work) {
        if (work === "principal") return "RefeiÃ§Ã£o principal";
        if (work === "cafe") return "CafÃ©";
        if (work === "sobremesa") return "Sobremesa";
        if (work === "lanche") return "Lanche";
        if (work === "ceia") return "Ceia";
        if (work === "petisco") return "Petisco";
        return work || "";
      }

      function normalizeLink(link) {
        if (!link) return "";
        if (link.startsWith("http://") || link.startsWith("https://")) {
          return link;
        }
        return "http://" + link;
      }

      // EdiÃ§Ã£o e exclusÃ£o de receitas
      let currentEditingRecipeId = null;
      function openRecipeForm(isEdit, recipe) {
        recipeFormCard.style.display = "block";
        recipeForm.scrollIntoView({ behavior: "smooth", block: "start" });

        if (isEdit && recipe) {
          recipeFormTitle.textContent = "Editar receita";
          fieldName.value = recipe.name || "";
          fieldKind.value = recipe.receita || "salgado";
          fieldWork.value = recipe.refeicao || "principal";
          fieldServings.value = recipe.servings || 3;
          fieldIngredients.value = Array.isArray(recipe.ingredients)
            ? recipe.ingredients.join("\n")
            : (recipe.ingredients || "");
          fieldInstructions.value = recipe.instructions || "";
          fieldLink.value = recipe.link || "";
          fieldPhoto.value = "";
          fieldFavorite.checked = !!(recipe.favorite);
          if (fieldProtein) {
            fieldProtein.value = recipe.proteina || "veg";
          }
        } else {
          recipeFormTitle.textContent = "Nova receita";
          recipeForm.reset();
          fieldKind.value = "salgado";
          fieldWork.value = "principal";
          fieldServings.value = 3;
          fieldLink.value = "";
          fieldFavorite.checked = false;
          if (fieldProtein) {
            fieldProtein.value = "veg";
          }
        }
      }

      function closeRecipeForm() {
        recipeFormCard.style.display = "none";
        currentEditingRecipeId = null;
      }

      if (btnNovaReceita) {
        btnNovaReceita.addEventListener("click", () => {
          currentEditingRecipeId = null;
          openRecipeForm(false, null);
        });
      }
      if (btnCancelarReceita) {
        btnCancelarReceita.addEventListener("click", () => {
          closeRecipeForm();
        });
      }

      // Salvar (adicionar ou editar) receita
      recipeForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const name = fieldName.value.trim();
        if (!name) {
          alert("Informe um nome para a receita.");
          return;
        }

        const ingredientsLines = fieldIngredients.value
          .split("\n")
          .map(l => l.trim())
          .filter(Boolean);

        const baseRecipe = {
          name,
          kind: fieldKind.value || "salgado",
          work: fieldWork.value || "principal",   // agora: tipo de refeiÃ§Ã£o
          protein: fieldProtein ? (fieldProtein.value || "veg") : "veg",
          servings: Number(fieldServings.value) || 3,
          ingredients: ingredientsLines,
          instructions: fieldInstructions.value.trim(),
          link: normalizeLink(fieldLink.value)
        };

        const file = fieldPhoto.files[0];

        function finishSave(photoDataUrl) {
          if (photoDataUrl) baseRecipe.photo = photoDataUrl;

          if (currentEditingRecipeId) {
            const idx = state.recipes.findIndex(r => r.id === currentEditingRecipeId);
            if (idx >= 0) {
              const existing = state.recipes[idx];
              state.recipes[idx] = {
                ...existing,
                ...baseRecipe,
                favorite: existing.favorite,
                photo: photoDataUrl || existing.photo || null
              };
            }
          } else {
            baseRecipe.id = generateId();
            baseRecipe.favorite = fieldFavorite.checked;
            baseRecipe.photo = baseRecipe.photo || null;
            state.recipes.push(baseRecipe);
          }

          state.recipes = normalizeRecipes(state.recipes);
          saveState();

          if (filterFav) filterFav.value = "";
          if (recipeSearch) recipeSearch.value = "";

          renderRecipesList();
          renderWeekView();
          closeRecipeForm();
        }

        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            finishSave(ev.target.result);
          };
          reader.readAsDataURL(file);
        } else {
          finishSave(null);
        }
      });

      const weekSelect = document.getElementById("weekSelect");
      const mealSelect = document.getElementById("mealSelect");
      const startWeekdaySelect = document.getElementById("startWeekdaySelect");
      const currentMealTitle = document.getElementById("currentMealTitle");
      const dayMealsContainer = document.getElementById("dayMealsContainer");
      const btnOpenRotinaForDay = document.getElementById("btnOpenRotinaForDay");

      const btnEditCurrentMeal = document.getElementById("btnEditCurrentMeal");
      const btnClearDay = document.getElementById("btnClearDay");
      const weekdayLabel = document.getElementById("weekdayLabel");

      // FunÃ§Ãµes de geraÃ§Ã£o de sugestÃ£o (rotina de sugestÃµes automÃ¡ticas)
      function generateSuggestionsNow(extra) {
        lastSuggestionIgnoredIds = [];
        const recs = buildSuggestions(lastSuggestionIgnoredIds, extra);
        renderSuggestions(recs);
      }

      if (btnGerarSugestoes) {
        btnGerarSugestoes.addEventListener("click", () => {
          generateSuggestionsNow();
        });
      }

      // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Visitas em casa â†’ prioriza salgado + mÃ©dio
      if (btnVisitasEmCasa) {
        btnVisitasEmCasa.addEventListener("click", () => {
          // NÃƒO forÃ§a petisco/salgado: sÃ³ prioriza petisco/lanche/favoritas no topo
          lastSuggestionIgnoredIds = [];
          generateSuggestionsNow({ extraMode: "visitas", maxResults: 999 });
        });
      }

      // ğŸ§º Tenho esses ingredientes â†’ pergunta e filtra por texto
      if (btnTenhoIngredientes) {
        btnTenhoIngredientes.addEventListener("click", () => {
          const txt = prompt("Digite ingredientes separados por vÃ­rgula (ex: ovo, queijo, tomate):");
          if (!txt) return;
          const ingredientsTokens = txt.split(",").map(s => s.trim()).filter(Boolean);
          lastSuggestionIgnoredIds = [];
          generateSuggestionsNow({ ingredientsTokens, extraMode: "filtrar", maxResults: 999 });
        });
      }

      // ... (cÃ³digo restante permanece igual, incluindo funÃ§Ãµes de computeMealStats para Resumo, etc.)
      // ObservaÃ§Ã£o: A seÃ§Ã£o Resumo foi removida da interface, mas a funÃ§Ã£o abaixo Ã© chamada somente se o elemento existir,
      // conforme a verificaÃ§Ã£o (if (!container) return) em seu inÃ­cio.
      function renderResumoStats() {
        const container = document.getElementById("statsResumoContent");
        if (!container) return;

        const st = computeMealStats();
        // (implementaÃ§Ã£o continua conforme original)
      }

      // ... (demais funÃ§Ãµes e event listeners)
    })();
  </script>
</body>
</html>
